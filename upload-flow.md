# Server æ¨¡å—ä¸Šä¼ åŠŸèƒ½æµç¨‹å›¾

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† tauri-local-send é¡¹ç›®ä¸­ server æ¨¡å—çš„æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æµç¨‹ã€‚

## ç›®å½•

1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [æœåŠ¡å™¨å¯åŠ¨æµç¨‹](#æœåŠ¡å™¨å¯åŠ¨æµç¨‹)
3. [å‰ç«¯ä¸Šä¼ æµç¨‹](#å‰ç«¯ä¸Šä¼ æµç¨‹)
4. [åç«¯å¤„ç†æµç¨‹](#åç«¯å¤„ç†æµç¨‹)
5. [æ•°æ®æµå‘å›¾](#æ•°æ®æµå‘å›¾)
6. [å…³é”®ä»£ç è¯´æ˜](#å…³é”®ä»£ç è¯´æ˜)

---

## æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Tauri åº”ç”¨                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   React å‰ç«¯ç•Œé¢     â”‚    â”‚      Rust åç«¯æœåŠ¡           â”‚    â”‚
â”‚  â”‚  (ç«¯å£ 1420)        â”‚    â”‚   (åŠ¨æ€ç«¯å£ 3000+)          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚                            â”‚                        â”‚
â”‚           â”‚  IPC invoke                â”‚ HTTP                   â”‚
â”‚           â–¼                            â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Warp HTTP æœåŠ¡å™¨                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚  GET /      â”‚          â”‚  POST /upload           â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  è¿”å›ä¸Šä¼ é¡µé¢ â”‚          â”‚  å¤„ç†æ–‡ä»¶ä¸Šä¼             â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ æ–‡ä»¶å†™å…¥
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    Downloads/LocalSend/        â”‚
              â”‚       (ç”¨æˆ·ä¸‹è½½ç›®å½•)            â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æœåŠ¡å™¨å¯åŠ¨æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"å¯åŠ¨æœåŠ¡"
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   start_server()    â”‚  ä½äº lib.rs:24
â”‚   Tauri command     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è·å–å¯ç”¨ç«¯å£        â”‚  network::get_free_port()
â”‚  (åŠ¨æ€åˆ†é… 3000+)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è·å–æœ¬æœº IP        â”‚  network::get_local_ip()
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»ºä¸Šä¼ ç›®å½•        â”‚  server::get_upload_dir()
â”‚  ~/Downloads/LocalSend
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”ŸæˆäºŒç»´ç           â”‚  qrcode::qr_to_data_url()
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯»å– HTML æ¨¡æ¿      â”‚  server::get_html_template()
â”‚  templates/upload.htmlâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é…ç½® Warp è·¯ç”±      â”‚
â”‚  - GET /            â”‚
â”‚  - POST /upload     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¯åŠ¨ HTTP æœåŠ¡å™¨    â”‚
â”‚  bind: 0.0.0.0:port â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
   è¿”å›æœåŠ¡å™¨ä¿¡æ¯
   {url, qrCode, ip, port}
```

### æ¨¡æ¿æ–‡ä»¶è¯»å–è·¯å¾„æœç´¢é¡ºåº

```
get_html_template() ä½äº server/mod.rs:22
â”‚
â”œâ”€â”€ å°è¯•è·¯å¾„ 1: templates/upload.html
â”œâ”€â”€ å°è¯•è·¯å¾„ 2: src-tauri/templates/upload.html
â”œâ”€â”€ å°è¯•è·¯å¾„ 3: {current_dir}/templates/upload.html
â”œâ”€â”€ å°è¯•è·¯å¾„ 4: ../Resources/templates/upload.html (macOS App)
â”œâ”€â”€ å°è¯•è·¯å¾„ 5: {exe_dir}/../Resources/templates/upload.html
â”‚
â””â”€â”€ å…¨éƒ¨å¤±è´¥ â†’ è¿”å›é”™è¯¯
```

---

## å‰ç«¯ä¸Šä¼ æµç¨‹

### ç”¨æˆ·ç•Œé¢äº¤äº’æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸Šä¼ é¡µé¢ (upload.html)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚   â”‚ ğŸ“¤ ç‚¹å‡»é€‰æ‹©   â”‚  â†â”€â”€ ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶                    â”‚
â”‚   â”‚   æ–‡ä»¶       â”‚                                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚          â”‚                                              â”‚
â”‚          â–¼                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚   â”‚ 3 ä¸ªæ–‡ä»¶     â”‚  â†â”€â”€ æ˜¾ç¤ºæ–‡ä»¶æ•°é‡å’Œæ€»å¤§å°               â”‚
â”‚   â”‚ (15.5 MB)    â”‚                                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚          â”‚                                              â”‚
â”‚          â–¼                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚   â”‚  å¼€å§‹ä¸Šä¼     â”‚  â†â”€â”€ æŒ‰é’®å¯ç”¨ï¼Œç‚¹å‡»å¼€å§‹                â”‚
â”‚   â”‚  [æŒ‰é’®]      â”‚                                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚          â”‚                                              â”‚
â”‚          â–¼                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚   â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 75% â”‚  â†â”€â”€ æ˜¾ç¤ºè¿›åº¦æ¡                        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚          â”‚                                              â”‚
â”‚          â–¼                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚   â”‚ âœ“ ä¸Šä¼ æˆåŠŸ   â”‚  â†â”€â”€ æ˜¾ç¤ºç»“æœï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### JavaScript ä¸Šä¼ é€»è¾‘æµç¨‹

```
ç”¨æˆ·é€‰æ‹©æ–‡ä»¶/æ‹–æ‹½æ–‡ä»¶
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å­˜å‚¨æ–‡ä»¶åˆ°æ•°ç»„      â”‚
â”‚  selectedFiles[]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  updateFileInfo()   â”‚
â”‚  - è®¡ç®—æ–‡ä»¶æ•°é‡      â”‚
â”‚  - è®¡ç®—æ€»å¤§å°        â”‚
â”‚  - å¯ç”¨ä¸Šä¼ æŒ‰é’®      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
ç”¨æˆ·ç‚¹å‡»"å¼€å§‹ä¸Šä¼ "
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   uploadFiles()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»º FormData      â”‚
â”‚  æ·»åŠ æ‰€æœ‰æ–‡ä»¶        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»º XMLHttpRequest â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€ ç›‘å¬ progress äº‹ä»¶ â”€â”€â†’ æ›´æ–°è¿›åº¦æ¡
       â”‚
       â”œâ”€â”€ ç›‘å¬ load äº‹ä»¶ â”€â”€â”€â”€â”€â”€â†’ æ˜¾ç¤ºæˆåŠŸ
       â”‚
       â”œâ”€â”€ ç›‘å¬ error äº‹ä»¶ â”€â”€â”€â”€â”€â†’ æ˜¾ç¤ºé”™è¯¯
       â”‚
       â””â”€â”€ ç›‘å¬ abort äº‹ä»¶ â”€â”€â”€â”€â”€â†’ æ˜¾ç¤ºå–æ¶ˆ
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  xhr.open('POST')   â”‚
â”‚  xhr.send(formData) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
    ç­‰å¾…æœåŠ¡å™¨å“åº”
```

### æ‹–æ‹½ä¸Šä¼ æµç¨‹

```
ç”¨æˆ·æ‹–æ‹½æ–‡ä»¶åˆ°ä¸Šä¼ åŒºåŸŸ
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  dragenter/dragover â”‚
â”‚  æ·»åŠ  dragover æ ·å¼  â”‚
â”‚  (é«˜äº®è¾¹æ¡†)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  drop               â”‚
â”‚  - é˜»æ­¢é»˜è®¤è¡Œä¸º      â”‚
â”‚  - ç§»é™¤é«˜äº®æ ·å¼      â”‚
â”‚  - è·å–æ–‡ä»¶åˆ—è¡¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å­˜å‚¨æ–‡ä»¶åˆ°æ•°ç»„      â”‚
â”‚  æ›´æ–°æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åç«¯å¤„ç†æµç¨‹

### HTTP è¯·æ±‚è·¯ç”±

```
HTTP Request
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Warp è·¯ç”±å™¨                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€ è·¯å¾„: / â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                  â”‚
     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
     â”‚    â”‚  è¿”å› upload.html   â”‚      â”‚
     â”‚    â”‚  HTML æ¨¡æ¿é¡µé¢      â”‚      â”‚
     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
     â”‚                                  â”‚
     â””â”€â”€ è·¯å¾„: /upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          æ–¹æ³•: POST                   â”‚
                                       â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
     â”‚  handle_upload()    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚  ä½äº lib.rs:74     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ–‡ä»¶ä¸Šä¼ å¤„ç†è¯¦ç»†æµç¨‹

```
handle_upload(form_data, upload_dir)
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. æ”¶é›†æ‰€æœ‰ multipart parts  â”‚
â”‚  while let Some(part) {...}   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. éå†æ¯ä¸ªæ–‡ä»¶ part          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. å¤„ç†æ–‡ä»¶å                â”‚
â”‚  - è·å–åŸå§‹æ–‡ä»¶å             â”‚
â”‚  - è¿‡æ»¤å±é™©å­—ç¬¦               â”‚
â”‚  - åªä¿ç•™ alphanumeric + .-_  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. å¤„ç†æ–‡ä»¶åå†²çª            â”‚
â”‚  IF file_exists(filename)    â”‚
â”‚    THEN                      â”‚
â”‚      filename â†’ filename_1   â”‚
â”‚      filename â†’ filename_2   â”‚
â”‚      ...ç›´åˆ°ä¸å†²çª            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. åˆ›å»ºç›®æ ‡æ–‡ä»¶              â”‚
â”‚  File::create(&filepath)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. æµå¼å†™å…¥æ–‡ä»¶              â”‚
â”‚  while let Some(chunk) {...}  â”‚
â”‚  - è¯»å–æ•°æ®å—                 â”‚
â”‚  - å†™å…¥æ–‡ä»¶                   â”‚
â”‚  - ç´¯åŠ å­—èŠ‚æ•°                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. åˆ·æ–°æ–‡ä»¶ç¼“å†²åŒº            â”‚
â”‚  file.flush()                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. æ›´æ–°å…¨å±€ç»Ÿè®¡              â”‚
â”‚  RECEIVED_COUNT += 1          â”‚
â”‚  TOTAL_SIZE += bytes_written  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  9. è¿”å› JSON å“åº”            â”‚
â”‚  {                            â”‚
â”‚    "success": true,           â”‚
â”‚    "message": "æˆåŠŸä¸Šä¼  N ä¸ªæ–‡ä»¶",
â”‚    "files": [...]             â”‚
â”‚  }                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é”™è¯¯å¤„ç†æµç¨‹

```
ä¸Šä¼ è¿‡ç¨‹ä¸­çš„é”™è¯¯
        â”‚
        â”œâ”€â”€â”¬â”€â”€ è¯»å– multipart é”™è¯¯
        â”‚  â”‚
        â”‚  â””â”€â”€â†’ warp::reject::custom(Error(...))
        â”‚
        â”œâ”€â”€â”¬â”€â”€ åˆ›å»ºæ–‡ä»¶é”™è¯¯
        â”‚  â”‚
        â”‚  â””â”€â”€â†’ warp::reject::custom(Error(...))
        â”‚
        â”œâ”€â”€â”¬â”€â”€ å†™å…¥æ–‡ä»¶é”™è¯¯
        â”‚  â”‚
        â”‚  â””â”€â”€â†’ warp::reject::custom(Error(...))
        â”‚
        â””â”€â”€â”¬â”€â”€ åˆ·æ–°ç¼“å†²åŒºé”™è¯¯
           â”‚
           â””â”€â”€â†’ warp::reject::custom(Error(...))
```

---

## æ•°æ®æµå‘å›¾

### å®Œæ•´æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     HTTP GET      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚   Warp Server   â”‚
â”‚  (æµè§ˆå™¨)    â”‚                   â”‚     GET /       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ templates/upload.htmlâ”‚
                              â”‚   (HTML æ¨¡æ¿æ–‡ä»¶)    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     HTML é¡µé¢   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯     â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   Warp Server   â”‚
â”‚  (æµè§ˆå™¨)    â”‚                 â”‚   (æ¸²æŸ“é¡µé¢)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ ç”¨æˆ·é€‰æ‹©æ–‡ä»¶
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  JavaScript     â”‚
â”‚  - æ”¶é›†æ–‡ä»¶      â”‚
â”‚  - æ˜¾ç¤ºè¿›åº¦      â”‚
â”‚  - XMLHttpRequestâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ multipart/form-data
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Warp Server   â”‚
â”‚   POST /upload  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”¬â”€â”€ è§£æ multipart
        â”‚  â–¼
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ â”‚  æµå¼è¯»å–æ•°æ®    â”‚
        â”‚ â”‚  part.stream()  â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”¬â”€â”€ æ–‡ä»¶åå¤„ç†
        â”‚  â–¼
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ â”‚ sanitize_filenameâ”‚
        â”‚ â”‚ å¤„ç†é‡åæ–‡ä»¶     â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â””â”€â”€â”¬â”€â”€ æ–‡ä»¶å†™å…¥
           â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ ~/Downloads/    â”‚
          â”‚   LocalSend/    â”‚
          â”‚   (æ–‡ä»¶ä¿å­˜)    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   JSON å“åº”     â”‚
â”‚ {success: true} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯         â”‚
â”‚  æ˜¾ç¤ºä¸Šä¼ æˆåŠŸ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…¨å±€ç»Ÿè®¡æ•°æ®æµ

```
server/mod.rs

RECEIVED_COUNT (AtomicUsize)
     â”‚
     â”œâ”€â”€ åˆå§‹åŒ–: 0
     â”‚
     â””â”€â”€ æ¯æ¬¡ä¸Šä¼ æˆåŠŸå +1
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ get_server_statusâ”‚â—„â”€â”€ IPC è°ƒç”¨
         â”‚ è¿”å›å·²æ¥æ”¶æ•°é‡    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         React å‰ç«¯æ˜¾ç¤º

TOTAL_SIZE (AtomicUsize)
     â”‚
     â”œâ”€â”€ åˆå§‹åŒ–: 0
     â”‚
     â””â”€â”€ æ¯æ¬¡ä¸Šä¼ æˆåŠŸå += æ–‡ä»¶å¤§å°
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ get_server_statusâ”‚â—„â”€â”€ IPC è°ƒç”¨
         â”‚ è¿”å›æ€»å¤§å°       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         React å‰ç«¯æ˜¾ç¤º
```

---

## å…³é”®ä»£ç è¯´æ˜

### 1. æœåŠ¡å™¨è·¯ç”±é…ç½® (lib.rs:41-51)

```rust
// é¦–é¡µè·¯ç”± - è¿”å›ä¸Šä¼ é¡µé¢
let routes = warp::path::end()
    .map(move || warp::reply::html(html_template.clone()));

// ä¸Šä¼ è·¯ç”± - å¤„ç†æ–‡ä»¶ä¸Šä¼ 
let upload_route = warp::path("upload")
    .and(warp::post())
    .and(warp::multipart::form().max_length(500_000_000))  // æœ€å¤§ 500MB
    .and(warp::any().map(move || upload_dir_clone.clone()))
    .and_then(handle_upload);

// åˆå¹¶è·¯ç”±
let routes = routes.or(upload_route);
```

### 2. æ–‡ä»¶åå¤„ç†é€»è¾‘ (lib.rs:86-111)

```rust
// æ¸…ç†æ–‡ä»¶åï¼Œåªä¿ç•™å®‰å…¨å­—ç¬¦
let sanitized: String = filename
    .chars()
    .filter(|&c| c.is_alphanumeric() || c == '.' || c == '-' || c == '_')
    .collect();

// å¤„ç†é‡åæ–‡ä»¶
if filepath.exists() {
    let ext = std::path::Path::new(&sanitized).extension()
        .map(|e| e.to_string_lossy().to_string())
        .unwrap_or_default();
    let stem = std::path::Path::new(&sanitized).file_stem()
        .map(|e| e.to_string_lossy().to_string())
        .unwrap_or("file".to_string());
    let mut counter = 1;
    loop {
        let new_name = if ext.is_empty() {
            format!("{}_{}", stem, counter)
        } else {
            format!("{}_{}.{}", stem, counter, ext)
        };
        filepath = upload_dir.join(&new_name);
        if !filepath.exists() { break; }
        counter += 1;
    }
}
```

### 3. æµå¼æ–‡ä»¶å†™å…¥ (lib.rs:116-126)

```rust
let mut stream = part.stream();
let mut bytes_written = 0usize;

while let Some(chunk_result) = stream.next().await {
    let chunk = chunk_result.map_err(|e| ...)?;
    let chunk_bytes = chunk.chunk();
    file.write_all(chunk_bytes).await.map_err(|e| ...)?;
    bytes_written += chunk_bytes.len();
}
```

### 4. å…¨å±€ç»Ÿè®¡æ›´æ–° (lib.rs:132-133)

```rust
// åŸå­æ“ä½œæ›´æ–°è®¡æ•°
server::RECEIVED_COUNT.fetch_add(1, std::sync::atomic::Ordering::SeqCst);
server::TOTAL_SIZE.fetch_add(bytes_written, std::sync::atomic::Ordering::SeqCst);
```

### 5. å‰ç«¯è¿›åº¦æ˜¾ç¤º (upload.html:152-157)

```javascript
xhr.upload.addEventListener('progress', function(e) {
    if (e.lengthComputable) {
        const percent = Math.round((e.loaded / e.total) * 100);
        progressFill.style.width = percent + '%';
        progressText.textContent = percent + '%';
    }
});
```

---

## æ–‡ä»¶ç»“æ„

```
src-tauri/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs              # ä¸»åº“æ–‡ä»¶ï¼ŒåŒ…å«æœåŠ¡å™¨å¯åŠ¨å’Œä¸Šä¼ å¤„ç†
â”‚   â”œâ”€â”€ server/
â”‚   â”‚   â””â”€â”€ mod.rs          # server æ¨¡å—ï¼Œæä¾›æ¨¡æ¿è¯»å–å’Œç»Ÿè®¡
â”‚   â”œâ”€â”€ network/            # ç½‘ç»œç›¸å…³
â”‚   â””â”€â”€ qrcode/             # äºŒç»´ç ç”Ÿæˆ
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ upload.html         # ä¸Šä¼ é¡µé¢æ¨¡æ¿
â””â”€â”€ Cargo.toml              # ä¾èµ–é…ç½®
```

---

## é…ç½®è¯´æ˜

### æ–‡ä»¶å¤§å°é™åˆ¶

- **ä¸Šä¼ é™åˆ¶**: 500MB (`max_length(500_000_000)`)
- **æ–‡ä»¶å­˜å‚¨ä½ç½®**: `~/Downloads/LocalSend/`
- **æ–‡ä»¶åå†²çªå¤„ç†**: è‡ªåŠ¨æ·»åŠ  `_1`, `_2` ç­‰åç¼€

### æ”¯æŒçš„ç‰¹æ€§

- âœ… å¤šæ–‡ä»¶ä¸Šä¼ 
- âœ… æ‹–æ‹½ä¸Šä¼ 
- âœ… ä¸Šä¼ è¿›åº¦æ˜¾ç¤º
- âœ… æ–‡ä»¶åå†²çªè‡ªåŠ¨å¤„ç†
- âœ… æµå¼å†™å…¥ï¼ˆå†…å­˜å‹å¥½ï¼‰
- âœ… å…¨å±€ç»Ÿè®¡ï¼ˆæ–‡ä»¶æ•°é‡å’Œæ€»å¤§å°ï¼‰
- âœ… é”™è¯¯å¤„ç†å’Œæç¤º

---

## æ€»ç»“

æ•´ä¸ªä¸Šä¼ åŠŸèƒ½é‡‡ç”¨äº†åˆ†å±‚æ¶æ„è®¾è®¡ï¼š

1. **å‰ç«¯å±‚**: çº¯ HTML + JavaScriptï¼Œè´Ÿè´£ç”¨æˆ·äº¤äº’å’Œè¿›åº¦æ˜¾ç¤º
2. **HTTP å±‚**: Warp æ¡†æ¶ï¼Œè´Ÿè´£è·¯ç”±å’Œè¯·æ±‚å¤„ç†
3. **ä¸šåŠ¡å±‚**: æ–‡ä»¶å¤„ç†é€»è¾‘ï¼ŒåŒ…æ‹¬æ–‡ä»¶åå¤„ç†å’Œæµå¼å†™å…¥
4. **å­˜å‚¨å±‚**: æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œä¿å­˜åˆ°ç”¨æˆ·ä¸‹è½½ç›®å½•

è¯¥è®¾è®¡ä¿è¯äº†ï¼š
- è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼ˆè¿›åº¦æ˜¾ç¤ºã€æ‹–æ‹½æ”¯æŒï¼‰
- å†…å­˜æ•ˆç‡ï¼ˆæµå¼å¤„ç†ï¼Œä¸åŠ è½½æ•´ä¸ªæ–‡ä»¶åˆ°å†…å­˜ï¼‰
- æ•°æ®å®‰å…¨ï¼ˆæ–‡ä»¶åè¿‡æ»¤ã€å†²çªå¤„ç†ï¼‰
- å¯ç»´æŠ¤æ€§ï¼ˆæ¨¡æ¿æ–‡ä»¶åˆ†ç¦»ï¼Œä¾¿äºä¿®æ”¹ï¼‰
